<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gallery - Thumbnail Browser</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }

      .header {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
      }

      .header h1 {
        margin: 0;
        color: #333;
      }

      .controls {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .search-input,
      .decrypt-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .search-input {
        width: 250px;
      }

      .decrypt-input {
        width: 150px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: #007bff;
        color: white;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn:hover {
        opacity: 0.9;
      }

      .gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
      }

      .book-item {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }

      .book-item:hover {
        transform: translateY(-5px);
      }

      .thumbnail-wrapper {
        position: relative;
        aspect-ratio: 3/4;
        overflow: hidden;
      }

      .thumbnail-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #f8f9fa;
      }

      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #666;
        font-size: 12px;
      }

      .book-info {
        padding: 12px;
      }

      .book-number {
        font-weight: bold;
        color: #007bff;
        font-size: 12px;
      }

      .book-title {
        font-size: 14px;
        margin: 5px 0;
        font-weight: 500;
        line-height: 1.3;
      }

      .book-artist {
        font-size: 12px;
        color: #666;
      }

      .status {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error {
        color: #dc3545;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Gallery</h1>
      <div class="controls">
        <input
          type="text"
          id="searchInput"
          class="search-input"
          placeholder="Search by title, book number, or tags..."
          onkeyup="searchBooks()"
        />
        <input
          type="password"
          id="decryptKey"
          class="decrypt-input"
          placeholder="Decrypt key..."
        />
        <button class="btn btn-primary" onclick="decryptThumbnails()">
          Decrypt
        </button>
        <a href="#" id="backButton" class="btn btn-secondary">Back</a>
      </div>
    </div>

    <div id="status" class="status">Loading...</div>
    <div id="gallery" class="gallery"></div>

    <script>
      // Global variables
      let githubToken = "";
      let booksData = [];
      let filteredBooks = [];
      let db = null;

      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyBgHpfJmeGjIS51nXKzFey5jI5LlkWwULc",
        authDomain: "cloud-2f6b2.firebaseapp.com",
        databaseURL:
          "https://cloud-2f6b2-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "cloud-2f6b2",
        storageBucket: "cloud-2f6b2.firebasestorage.app",
        messagingSenderId: "686332242533",
        appId: "1:686332242533:web:c23058e3ebc7ecd241f48c",
        measurementId: "G-FGFG1K9Q1E",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();

      // Get GitHub token from URL
      function getTokenFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token");
        const type = urlParams.get("type");

        if (token && type === "github") {
          githubToken = token;
          console.log("GitHub token received");
        }

        // Set back button URL
        const backUrl = token
          ? `index.html?token=${encodeURIComponent(token)}&type=${type}`
          : "index.html";
        document.getElementById("backButton").href = backUrl;
      }

      // Load books from Firebase
      async function loadBooks() {
        try {
          console.log("Loading books from Firebase...");
          const querySnapshot = await db.collection("Book").get();

          booksData = [];
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            // Only include books that have thumbnail_url
            if (data.thumbnail_url) {
              booksData.push({
                id: doc.id,
                ...data,
              });
            }
          });

          console.log(`Loaded ${booksData.length} books with thumbnails`);
          filteredBooks = [...booksData];
          displayBooks();
        } catch (error) {
          console.error("Error loading books:", error);
          document.getElementById("status").innerHTML =
            '<div class="error">Error loading books from Firebase</div>';
        }
      }

      // Display books in gallery
      function displayBooks() {
        const gallery = document.getElementById("gallery");
        const status = document.getElementById("status");

        if (filteredBooks.length === 0) {
          status.textContent = "No books found with thumbnails.";
          gallery.innerHTML = "";
          return;
        }

        status.style.display = "none";

        gallery.innerHTML = filteredBooks
          .map((book) => {
            const title = book.title || "Unknown Title";
            const artist = getArtist(book.tags);

            return `
                    <div class="book-item">
                        <div class="thumbnail-wrapper">
                            <img class="thumbnail-image" 
                                 src="data:image/svg+xml;base64,${btoa(
                                   '<svg xmlns="http://www.w3.org/2000/svg" width="200" height="250"><rect width="100%" height="100%" fill="#f8f9fa"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="14" fill="#666">Loading...</text></svg>'
                                 )}"
                                 data-thumbnail-url="${book.thumbnail_url}"
                                 data-book-id="${book.id}"
                                 alt="Book ${book.id}">
                            <div class="loading">Loading...</div>
                        </div>
                        <div class="book-info">
                            <div class="book-number">#${book.id}</div>
                            <div class="book-title">${escapeHtml(title)}</div>
                            <div class="book-artist">${escapeHtml(artist)}</div>
                        </div>
                    </div>
                `;
          })
          .join("");

        // Load thumbnails
        loadThumbnails();
      }

      // Extract artist from tags
      function getArtist(tags) {
        if (!tags || typeof tags !== "object") return "Unknown Artist";

        const artistFields = ["artist", "creator", "author"];
        for (const field of artistFields) {
          if (
            tags[field] &&
            Array.isArray(tags[field]) &&
            tags[field].length > 0
          ) {
            return tags[field].join(", ");
          }
        }
        return "Unknown Artist";
      }

      // Escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Load thumbnails
      async function loadThumbnails() {
        const images = document.querySelectorAll(".thumbnail-image");

        for (const img of images) {
          const thumbnailUrl = img.dataset.thumbnailUrl;
          const bookId = img.dataset.bookId;

          try {
            await loadThumbnail(img, thumbnailUrl);
          } catch (error) {
            console.error(
              `Failed to load thumbnail for book ${bookId}:`,
              error
            );
            img.src = `data:image/svg+xml;base64,${btoa(
              '<svg xmlns="http://www.w3.org/2000/svg" width="200" height="250"><rect width="100%" height="100%" fill="#f8f9fa" stroke="#dee2e6"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="14" fill="#dc3545">Load Error</text></svg>'
            )}`;
          }

          // Hide loading indicator
          const loading = img.parentElement.querySelector(".loading");
          if (loading) loading.style.display = "none";
        }
      }

      // Load single thumbnail
      async function loadThumbnail(img, thumbnailUrl, decrypt = false) {
        const headers = githubToken
          ? { Authorization: `token ${githubToken}` }
          : {};
        const response = await fetch(thumbnailUrl, { headers });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        if (decrypt) {
          const encryptedData = new Uint8Array(await response.arrayBuffer());
          const decryptKey = document.getElementById("decryptKey").value.trim();

          if (!decryptKey) {
            throw new Error("Decrypt key required");
          }

          const decryptedData = decryptXOR(encryptedData, decryptKey);
          const blob = new Blob([decryptedData], { type: "image/png" });
          img.src = URL.createObjectURL(blob);
        } else {
          const blob = await response.blob();
          img.src = URL.createObjectURL(blob);
        }
      }

      // XOR decryption
      function decryptXOR(data, key) {
        const keyBytes = new TextEncoder().encode(key).slice(0, 16);
        const result = new Uint8Array(data.length);

        for (let i = 0; i < data.length; i++) {
          result[i] = data[i] ^ keyBytes[i % keyBytes.length];
        }

        return result;
      }

      // Search books
      function searchBooks() {
        const query = document
          .getElementById("searchInput")
          .value.toLowerCase()
          .trim();

        if (!query) {
          filteredBooks = [...booksData];
        } else {
          filteredBooks = booksData.filter((book) => {
            const title = (book.title || "").toLowerCase();
            const bookId = book.id.toLowerCase();
            const artist = getArtist(book.tags).toLowerCase();

            // Search in tags
            let tagsText = "";
            if (book.tags && typeof book.tags === "object") {
              tagsText = JSON.stringify(book.tags).toLowerCase();
            }

            return (
              title.includes(query) ||
              bookId.includes(query) ||
              artist.includes(query) ||
              tagsText.includes(query)
            );
          });
        }

        displayBooks();
      }

      // Decrypt all thumbnails
      async function decryptThumbnails() {
        const decryptKey = document.getElementById("decryptKey").value.trim();

        if (!decryptKey) {
          alert("Please enter a decrypt key.");
          return;
        }

        const images = document.querySelectorAll(".thumbnail-image");

        for (const img of images) {
          const thumbnailUrl = img.dataset.thumbnailUrl;
          const bookId = img.dataset.bookId;

          try {
            await loadThumbnail(img, thumbnailUrl, true);
            console.log(`Decrypted thumbnail for book ${bookId}`);
          } catch (error) {
            console.error(
              `Failed to decrypt thumbnail for book ${bookId}:`,
              error
            );
          }
        }
      }

      // Initialize
      window.onload = function () {
        getTokenFromUrl();
        loadBooks();
      };
    </script>
  </body>
</html>
