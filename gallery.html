<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gallery - Thumbnail Browser</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 10px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .search-box {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .back-button {
        padding: 8px 16px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }

      .token-section {
        text-align: center;
        margin: 50px auto;
        padding: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        max-width: 400px;
      }

      .token-input {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        width: 250px;
        margin-right: 10px;
      }

      .token-button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .token-button:hover {
        background-color: #0056b3;
      }

      .gallery-content {
        display: none;
      }

      .back-button:hover {
        background-color: #5a6268;
      }

      .gallery-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .thumbnail-item {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
      }

      .thumbnail-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .thumbnail-image {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 10px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
      }

      .book-number {
        font-weight: bold;
        font-size: 16px;
        color: #333;
        margin-bottom: 5px;
      }

      .book-title {
        font-size: 12px;
        color: #666;
        word-wrap: break-word;
        max-height: 40px;
        overflow: hidden;
      }

      .loading {
        text-align: center;
        padding: 40px;
        font-size: 16px;
        color: #666;
      }

      .error {
        text-align: center;
        padding: 40px;
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        margin: 20px 0;
      }

      .no-thumbnails {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        font-size: 16px;
      }

      .encryption-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        width: 200px;
      }

      .decrypt-button {
        padding: 8px 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
      }

      .decrypt-button:hover {
        background-color: #0056b3;
      }

      .decrypt-button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <!-- Firebase Token Section -->
    <div id="tokenSection" class="token-section">
      <h2>Gallery Access</h2>
      <p>Upload your Firebase service account JSON file</p>

      <!-- File Upload Option -->
      <div
        style="
          margin-bottom: 15px;
          padding: 15px;
          border: 2px dashed #007bff;
          border-radius: 8px;
          text-align: center;
          background-color: #f8f9fa;
        "
      >
        <p style="margin: 0 0 15px 0; font-size: 16px; color: #333">
          üìÅ Select Firebase JSON file
        </p>
        <input
          type="file"
          id="tokenFileInput"
          accept=".json"
          style="margin-bottom: 15px"
          onchange="handleTokenFile(event)"
        />
        <br />
        <button
          onclick="loadTokenFromFile()"
          class="token-button"
          id="fileTokenButton"
          disabled
        >
          Load Firebase Token
        </button>
      </div>

      <p style="font-size: 12px; color: #666">
        For testing:
        <a href="#" onclick="testServiceAccount()" style="color: #007bff"
          >test with sample service account</a
        >
        or
        <a href="#" onclick="bypassFirebaseAuth()" style="color: #007bff"
          >bypass authentication</a
        >
      </p>

      <!-- JSON File Format Info -->
      <details style="font-size: 11px; color: #888; margin-top: 10px">
        <summary style="cursor: pointer">
          Firebase JSON format (downloaded from Firebase)
        </summary>
        <pre
          style="
            background: #f5f5f5;
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
          "
        >
{
  "type": "service_account",
  "project_id": "your-project-id",
  "private_key_id": "key-id",
  "private_key": "-----BEGIN PRIVATE KEY-----\n...",
  "client_email": "service-account@project.iam.gserviceaccount.com",
  "client_id": "...",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token"
}</pre
        >
        <p style="margin: 5px 0; font-size: 10px">
          This is the service account JSON downloaded from Firebase Console
        </p>
      </details>
    </div>

    <!-- Gallery Content (hidden until token is validated) -->
    <div id="galleryContent" class="gallery-content">
      <div class="header">
        <h2>Gallery - Thumbnail Browser</h2>
        <div class="controls">
          <input
            type="text"
            id="searchInput"
            class="search-box"
            placeholder="Search by title, tags, or book number..."
            onkeyup="filterThumbnails()"
          />
          <input
            type="password"
            id="encryptionKey"
            class="encryption-input"
            placeholder="Enter encryption key..."
          />
          <button class="decrypt-button" onclick="decryptThumbnails()">
            Decrypt Thumbnails
          </button>
          <a href="#" id="backButton" class="back-button">Back to Main</a>
        </div>
      </div>

      <div id="loadingMessage" class="loading">Loading thumbnails...</div>
      <div id="errorMessage" class="error" style="display: none"></div>
      <div id="noThumbnailsMessage" class="no-thumbnails" style="display: none">
        No thumbnails found
      </div>
      <div id="galleryContainer" class="gallery-container"></div>
    </div>
    <!-- End of galleryContent -->

    <script>
      let githubToken = "";
      let firebaseToken = "";
      let tokenType = "";
      let thumbnailsData = [];
      let encryptionKey = "";
      let db = null;

      // Firebase configuration (public config - safe to expose)
      const firebaseConfig = {
        apiKey: "AIzaSyBgHpfJmeGjIS51nXKzFey5jI5LlkWwULc",
        authDomain: "cloud-2f6b2.firebaseapp.com",
        databaseURL:
          "https://cloud-2f6b2-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "cloud-2f6b2",
        storageBucket: "cloud-2f6b2.firebasestorage.app",
        messagingSenderId: "686332242533",
        appId: "1:686332242533:web:c23058e3ebc7ecd241f48c",
        measurementId: "G-FGFG1K9Q1E",
      };

      // Initialize Firebase
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
      } catch (error) {
        console.error("Firebase initialization failed:", error);
      }

      // Load thumbnails from Firebase
      async function loadThumbnailsFromFirebase() {
        try {
          console.log("Attempting to load books from Firebase...");

          // Try to access the Book collection
          const querySnapshot = await db.collection("Book").get();
          thumbnailsData = [];

          if (querySnapshot.empty) {
            console.log("No books found in Firebase collection");
            loadSampleData(); // Load sample data if Firebase is empty
            return;
          }

          querySnapshot.forEach((doc) => {
            const data = doc.data();
            thumbnailsData.push({
              id: doc.id,
              ...data,
            });
          });

          console.log(`Loaded ${thumbnailsData.length} books from Firebase`);
          displayThumbnails(thumbnailsData);
        } catch (error) {
          console.error("Error loading books from Firebase:", error);

          // Load sample data if Firebase access fails
          console.log("Loading sample data due to Firebase access issue");
          loadSampleData();
        }
      }

      // Load sample data for testing when Firebase is not available
      function loadSampleData() {
        console.log("Loading sample data for testing");
        thumbnailsData = [
          {
            id: "1963638",
            title: "Katei Kyoushi no Onii-san to Koumon de Car SEX",
            artist: "Mankai Kaika",
            tags: ["Chinese", "Adult"],
            BookNumber: "1963638",
          },
          {
            id: "2973547",
            title: "Hatsu Seishori Touban no Tachibana-san",
            artist: "Hoshicha",
            tags: ["Chinese", "THE IDOLM@STER"],
            BookNumber: "2973547",
          },
          {
            id: "3283375",
            title: "Pixiv & Fanbox Collection",
            artist: "„Åµ„Çâ„Å£„Åó„ÇÉ„Éº flasher",
            tags: ["Pixiv", "Fanbox"],
            BookNumber: "3283375",
          },
        ];

        console.log(`Loaded ${thumbnailsData.length} sample books`);
        displayThumbnails(thumbnailsData);
      }

      // Display thumbnails with Firebase data
      function displayThumbnails(books) {
        const container = document.getElementById("thumbnailContainer");
        container.innerHTML = "";

        if (books.length === 0) {
          container.innerHTML =
            '<p style="text-align: center; color: #666;">No books found.</p>';
          return;
        }

        books.forEach((book) => {
          const div = document.createElement("div");
          div.className = "thumbnail-item";

          // Create book info display
          const title = book.title || book.Title || "Unknown Title";
          const artist = book.artist || book.Artist || "Unknown Artist";
          const bookNumber = book.id || book.BookNumber || "N/A";

          div.innerHTML = `
            <div class="thumbnail-wrapper">
              <img class="thumbnail-image" data-book-id="${bookNumber}" alt="Loading..." />
              <div class="loading-overlay">Loading...</div>
            </div>
            <div class="book-info">
              <div class="book-number">#${bookNumber}</div>
              <div class="book-title">${title}</div>
              <div class="book-artist">${artist}</div>
            </div>
          `;

          container.appendChild(div);
        });

        // Load actual thumbnail images
        loadThumbnailImages();
      }

      // Load and decrypt thumbnail images from GitHub
      async function loadThumbnailImages() {
        if (!githubToken) {
          console.warn("No GitHub token available for thumbnail loading");
          return;
        }

        const images = document.querySelectorAll(".thumbnail-image");

        for (let img of images) {
          const bookId = img.dataset.bookId;
          try {
            await loadSingleThumbnail(img, bookId);
          } catch (error) {
            console.error(
              `Failed to load thumbnail for book ${bookId}:`,
              error
            );
            img.src =
              "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI1MCIgZmlsbD0iI2Y0ZjRmNCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij5ObyBJbWFnZTwvdGV4dD48L3N2Zz4=";
          }
        }
      }

      // Load a single thumbnail from GitHub and decrypt it
      async function loadSingleThumbnail(imgElement, bookId) {
        const loadingOverlay =
          imgElement.parentElement.querySelector(".loading-overlay");

        try {
          // Show loading
          if (loadingOverlay) loadingOverlay.style.display = "block";

          // Get thumbnail from GitHub API
          const apiUrl = `https://api.github.com/repos/hsiaofongw/thumbnails/contents/${bookId}.png`;
          const response = await fetch(apiUrl, {
            headers: {
              Authorization: `token ${githubToken}`,
              Accept: "application/vnd.github.v3+json",
            },
          });

          if (!response.ok) {
            throw new Error(`GitHub API error: ${response.status}`);
          }

          const data = await response.json();

          // Decode base64 content
          const binaryString = atob(data.content.replace(/\s/g, ""));
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }

          // Create blob and URL
          const blob = new Blob([bytes], { type: "image/png" });
          const url = URL.createObjectURL(blob);

          // Set image source
          imgElement.src = url;
          imgElement.dataset.encrypted = "true";

          // Hide loading
          if (loadingOverlay) loadingOverlay.style.display = "none";
        } catch (error) {
          console.error(`Error loading thumbnail for ${bookId}:`, error);
          // Hide loading and show error placeholder
          if (loadingOverlay) loadingOverlay.style.display = "none";
          imgElement.src =
            "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI1MCIgZmlsbD0iI2Y0ZjRmNCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij5ObyBJbWFnZTwvdGV4dD48L3N2Zz4=";
          throw error;
        }
      }

      // Search function for Firebase data
      function searchBooks() {
        const query = document
          .getElementById("searchInput")
          .value.toLowerCase()
          .trim();

        if (!query) {
          displayThumbnails(thumbnailsData);
          return;
        }

        const filteredBooks = thumbnailsData.filter((book) => {
          const title = (book.title || book.Title || "").toLowerCase();
          const artist = (book.artist || book.Artist || "").toLowerCase();
          const tags = (book.tags || book.Tags || "").toLowerCase();
          const bookNumber = (book.id || book.BookNumber || "").toString();

          return (
            title.includes(query) ||
            artist.includes(query) ||
            tags.includes(query) ||
            bookNumber.includes(query)
          );
        });

        displayThumbnails(filteredBooks);
      }

      // Legacy function for compatibility
      function filterThumbnails() {
        searchBooks();
      }

      // Bypass authentication for testing
      function bypassFirebaseAuth() {
        if (
          confirm(
            "Bypass Firebase authentication? This is for testing purposes only."
          )
        ) {
          firebaseToken = "bypass_auth_token";
          proceedToGallery();
        }
      }

      // Test with sample service account
      function testServiceAccount() {
        const sampleServiceAccount = {
          type: "service_account",
          project_id: "cloud-2f6b2",
          private_key_id: "sample_key_id",
          private_key:
            "-----BEGIN PRIVATE KEY-----\nsample_private_key_content\n-----END PRIVATE KEY-----\n",
          client_email: "firebase-adminsdk@cloud-2f6b2.iam.gserviceaccount.com",
        };

        firebaseToken = sampleServiceAccount.private_key;
        console.log("Testing with sample service account");
        proceedToGallery();
      }

      // Proceed to gallery after successful authentication
      function proceedToGallery() {
        alert("Firebase token validated successfully!");

        // Hide token section and show gallery
        document.getElementById("tokenSection").style.display = "none";
        document.getElementById("galleryContent").style.display = "block";

        setupGallery();
      }

      // File upload handling
      let uploadedTokenData = null;

      function handleTokenFile(event) {
        const file = event.target.files[0];
        const button = document.getElementById("fileTokenButton");

        if (file && file.type === "application/json") {
          button.disabled = false;
          button.textContent = `Load from ${file.name}`;
        } else {
          button.disabled = true;
          button.textContent = "Load Firebase Token";
          if (file) {
            alert("Please select a valid JSON file.");
          }
        }
      }

      async function loadTokenFromFile() {
        const fileInput = document.getElementById("tokenFileInput");
        const file = fileInput.files[0];

        if (!file) {
          alert("Please select a Firebase JSON file first.");
          return;
        }

        try {
          const text = await file.text();
          const firebaseData = JSON.parse(text);

          // Check if it's a Firebase service account JSON
          if (
            firebaseData.type === "service_account" &&
            firebaseData.private_key
          ) {
            // Use the private_key as our Firebase token for authentication
            firebaseToken = firebaseData.private_key;
            console.log("Firebase service account loaded from file");
          } else if (firebaseData.firebaseToken) {
            // Fallback: if it's a custom format with firebaseToken field
            firebaseToken = firebaseData.firebaseToken;
            console.log("Custom Firebase token loaded from file");
          } else {
            throw new Error(
              "Invalid Firebase JSON format. Expected service account JSON or custom token format."
            );
          }

          // Auto-fill the input field for user verification (show truncated version)
          const displayToken =
            firebaseToken.length > 50
              ? firebaseToken.substring(0, 30) + "..."
              : firebaseToken.substring(0, 20) + "...";
          document.getElementById("firebaseTokenInput").value = displayToken;

          // Automatically validate the token
          await validateLoadedToken();
        } catch (error) {
          console.error("Error reading Firebase JSON file:", error);
          alert(`Error reading Firebase JSON: ${error.message}`);
        }
      }

      async function validateLoadedToken() {
        try {
          // Check for test token
          if (firebaseToken === "test123456789012345") {
            console.log(
              "Using test token from file - bypassing Firebase authentication"
            );
            proceedToGallery();
            return;
          }

          // Check for service account private key
          if (firebaseToken.includes("-----BEGIN PRIVATE KEY-----")) {
            console.log("Service account private key loaded from file");
            proceedToGallery();
            return;
          }

          // Basic validation for other token types
          if (firebaseToken.length >= 20) {
            console.log("Token from file appears valid");
            proceedToGallery();
            return;
          }

          throw new Error("Invalid token format in file");
        } catch (error) {
          console.error("File token validation error:", error);
          alert(`Invalid token in file: ${error.message}`);
        }
      }

      function setupGallery() {
        // Set up back button
        const backUrl = githubToken
          ? `index.html?token=${encodeURIComponent(
              githubToken
            )}&type=${tokenType}`
          : "index.html";
        document.getElementById("backButton").href = backUrl;

        // Load thumbnails from Firebase
        loadThumbnailsFromFirebase();
      }

      // XOR Decryption function (same as your Python implementation)
      function decryptXOR(encryptedData, key) {
        console.log("Decrypting with key:", key);
        console.log("Encrypted data length:", encryptedData.length);

        if (typeof key === "string") {
          key = new TextEncoder().encode(key);
        }

        // Truncate key to 16 bytes (same as Python key.encode('utf-8')[:16])
        key = key.slice(0, 16);
        console.log("Key bytes (truncated to 16):", Array.from(key));

        // Reverse the key (same as Python key[::-1])
        key = Array.from(key).reverse();
        console.log("Reversed key bytes:", key);

        const decryptedData = new Uint8Array(encryptedData.length);
        const keyLen = key.length;

        for (let i = 0; i < encryptedData.length; i++) {
          decryptedData[i] = encryptedData[i] ^ key[i % keyLen];
        }

        console.log(
          "Decrypted data first 20 bytes:",
          Array.from(decryptedData.slice(0, 20))
        );
        return decryptedData;
      }

      // Get token from URL parameters
      function getTokenFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        token = urlParams.get("token");
        tokenType = urlParams.get("type") || "firebase";

        if (!token) {
          alert("No token found. Redirecting to main page.");
          window.location.href = "index.html";
          return;
        }

        // Set back button link
        document.getElementById(
          "backButton"
        ).href = `index.html?token=${encodeURIComponent(
          token
        )}&type=${tokenType}`;

        // Load thumbnails from Firebase
        loadThumbnailsFromFirebase();
      }

      // Load thumbnails from Firebase collection
      async function loadThumbnailsFromFirebase() {
        try {
          console.log("Attempting to load books from Firebase...");

          if (!db) {
            throw new Error("Firebase not initialized");
          }

          // Try to access the Book collection
          const booksSnapshot = await db.collection("Book").get();

          if (booksSnapshot.empty) {
            console.log("No books found in Firebase collection");
            loadSampleData(); // Load sample data if Firebase is empty
            return;
          }

          // Process Firebase documents into thumbnails data
          thumbnailsData = [];
          booksSnapshot.forEach((doc) => {
            const data = doc.data();
            const bookNumber = doc.id; // Document ID is the book number

            // Create thumbnail data object
            const thumbnailData = {
              bookNumber: bookNumber,
              title: data.title || "Unknown Title",
              uploadTime: data.upload_time || data.uploadTime || "Unknown",
              downloadTime:
                data.download_time || data.downloadTime || "Unknown",
              tags: data.tags || {},
              thumbnailUrl: data.thumbnail_url || data.thumbnailUrl || null,
              videoIds: data.video_ids || data.videoIds || [],
              encrypted: data.encrypted || false,
              filePath: data.file_path || data.filePath || "",
            };

            thumbnailsData.push(thumbnailData);
          });

          // Sort by book number
          thumbnailsData.sort(
            (a, b) => parseInt(a.bookNumber) - parseInt(b.bookNumber)
          );

          console.log(`Loaded ${thumbnailsData.length} books from Firebase`);
          displayThumbnails(thumbnailsData);
        } catch (error) {
          console.error("Error loading books from Firebase:", error);

          // Load sample data if Firebase access fails
          console.log("Loading sample data due to Firebase access issue");
          loadSampleData();
        }
      }

      // Load sample data for testing when Firebase is not available
      function loadSampleData() {
        console.log("Loading sample data for testing");
        thumbnailsData = [
          {
            bookNumber: "1963638",
            title: "Katei Kyoushi no Onii-san to Koumon de Car SEX",
            uploadTime: "2024-01-01",
            downloadTime: "2024-01-01",
            tags: { category: ["Chinese"], series: ["Adult"] },
            encrypted: true,
            thumbnailUrl: null,
            videoIds: [],
            filePath: "",
          },
          {
            bookNumber: "2973547",
            title: "Hatsu Seishori Touban no Tachibana-san",
            uploadTime: "2024-01-02",
            downloadTime: "2024-01-02",
            tags: { category: ["Chinese"], series: ["THE IDOLM@STER"] },
            encrypted: true,
            thumbnailUrl: null,
            videoIds: [],
            filePath: "",
          },
          {
            bookNumber: "3283375",
            title: "Pixiv & Fanbox Collection",
            uploadTime: "2024-01-03",
            downloadTime: "2024-01-03",
            tags: { platform: ["Pixiv", "Fanbox"] },
            encrypted: true,
            thumbnailUrl: null,
            videoIds: [],
            filePath: "",
          },
        ];

        console.log(`Loaded ${thumbnailsData.length} sample books`);

        // Hide loading messages and show content
        const loadingMsg = document.getElementById("loadingMessage");
        const errorMsg = document.getElementById("errorMessage");
        const noThumbnailsMsg = document.getElementById("noThumbnailsMessage");

        if (loadingMsg) loadingMsg.style.display = "none";
        if (errorMsg) errorMsg.style.display = "none";
        if (noThumbnailsMsg) noThumbnailsMsg.style.display = "none";

        displayThumbnails(thumbnailsData);
      }

      // Display thumbnails in the gallery
      function displayThumbnails(thumbnails) {
        const container = document.getElementById("galleryContainer");
        container.innerHTML = "";

        thumbnails.forEach((thumbnail) => {
          const item = document.createElement("div");
          item.className = "thumbnail-item";
          item.onclick = () => showThumbnailDetails(thumbnail);

          const img = document.createElement("img");
          img.className = "thumbnail-image";
          img.alt = `Book ${thumbnail.bookNumber}`;

          if (encryptionKey && thumbnail.thumbnailUrl) {
            // If encryption key is provided and thumbnail URL exists, try to decrypt and display
            loadAndDecryptThumbnail(img, thumbnail);
          } else {
            // Show placeholder for encrypted thumbnail or missing thumbnail
            const placeholderText = thumbnail.thumbnailUrl
              ? "Encrypted"
              : "No Thumbnail";
            img.src = `data:image/svg+xml;base64,${btoa(`
              <svg width="200" height="250" xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="#f8f9fa" stroke="#dee2e6"/>
                <text x="50%" y="50%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="14" fill="#6c757d">
                  ${placeholderText}
                </text>
              </svg>
            `)}`;
          }

          const bookNumber = document.createElement("div");
          bookNumber.className = "book-number";
          bookNumber.textContent = `Book #${thumbnail.bookNumber}`;

          const bookTitle = document.createElement("div");
          bookTitle.className = "book-title";
          bookTitle.textContent = thumbnail.title || "No Title";

          // Add tags display
          const tagsDiv = document.createElement("div");
          tagsDiv.className = "book-tags";
          tagsDiv.style.fontSize = "10px";
          tagsDiv.style.color = "#888";
          tagsDiv.style.marginTop = "5px";
          if (thumbnail.tags && typeof thumbnail.tags === "object") {
            const tagTexts = [];
            Object.entries(thumbnail.tags).forEach(([category, values]) => {
              if (Array.isArray(values)) {
                values.forEach((value) =>
                  tagTexts.push(`${category}:${value}`)
                );
              }
            });
            tagsDiv.textContent =
              tagTexts.slice(0, 3).join(", ") +
              (tagTexts.length > 3 ? "..." : "");
          }

          item.appendChild(img);
          item.appendChild(bookNumber);
          item.appendChild(bookTitle);
          item.appendChild(tagsDiv);
          container.appendChild(item);
        });
      }

      // Load and decrypt thumbnail from Firebase URL
      async function loadAndDecryptThumbnail(imgElement, thumbnail) {
        try {
          if (!thumbnail.thumbnailUrl) {
            console.log(
              "No thumbnail URL found for book:",
              thumbnail.bookNumber
            );
            imgElement.src = `data:image/svg+xml;base64,${btoa(`
              <svg width="200" height="250" xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="#f8f9fa" stroke="#dee2e6"/>
                <text x="50%" y="50%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="14" fill="#dc3545">
                  No Thumbnail
                </text>
              </svg>
            `)}`;
            return;
          }

          console.log("Loading thumbnail from URL:", thumbnail.thumbnailUrl);

          // Fetch encrypted thumbnail from the URL stored in Firebase
          const response = await fetch(thumbnail.thumbnailUrl);

          if (!response.ok) {
            throw new Error(`Failed to load thumbnail: ${response.status}`);
          }

          const encryptedData = new Uint8Array(await response.arrayBuffer());
          console.log(
            "Downloaded encrypted data length:",
            encryptedData.length
          );
          console.log(
            "First 20 bytes of encrypted data:",
            Array.from(encryptedData.slice(0, 20))
          );

          const decryptedData = decryptXOR(encryptedData, encryptionKey);

          // Try to detect if it's a valid image by checking magic bytes
          const magicBytes = Array.from(decryptedData.slice(0, 4));
          console.log("Decrypted magic bytes:", magicBytes);

          const blob = new Blob([decryptedData]);
          const objectUrl = URL.createObjectURL(blob);

          imgElement.onload = () => URL.revokeObjectURL(objectUrl);
          imgElement.onerror = () => {
            URL.revokeObjectURL(objectUrl);
            imgElement.src = `data:image/svg+xml;base64,${btoa(`
              <svg width="200" height="250" xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="#f8f9fa" stroke="#dee2e6"/>
                <text x="50%" y="50%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="14" fill="#dc3545">
                  Decrypt Failed
                </text>
              </svg>
            `)}`;
          };

          imgElement.src = objectUrl;
        } catch (error) {
          console.error("Error decrypting thumbnail:", error);
          imgElement.src =
            "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIiBzdHJva2U9IiNkZWUyZTYiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2RjMzU0NSI+TG9hZCBFcnJvcjwvdGV4dD48L3N2Zz4=";
        }
      }

      // Decrypt all thumbnails
      function decryptThumbnails() {
        encryptionKey = document.getElementById("encryptionKey").value.trim();
        if (!encryptionKey) {
          alert("Please enter an encryption key.");
          return;
        }

        // Re-display thumbnails with decryption
        displayThumbnails(thumbnailsData);
      }

      // Filter thumbnails by search (searches title, tags, and book number)
      // Show thumbnail details with Firebase data
      function showThumbnailDetails(thumbnail) {
        const title = thumbnail.title || thumbnail.Title || "Unknown Title";
        const artist = thumbnail.artist || thumbnail.Artist || "Unknown Artist";
        const tags = thumbnail.tags || thumbnail.Tags || {};
        const tagsText =
          typeof tags === "object" ? JSON.stringify(tags, null, 2) : tags;

        alert(`Book Number: ${thumbnail.id || thumbnail.BookNumber}
Title: ${title}
Artist: ${artist}
Tags: ${tagsText}
Encrypted: ${thumbnail.encrypted ? "Yes" : "No"}
Has Thumbnail: ${thumbnail.thumbnailUrl ? "Yes" : "No"}`);
      }

      // Check if GitHub token is provided via URL (from index.html)
      function getTokensFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get("token") || "";
        const urlTokenType = urlParams.get("type") || "";

        if (
          urlToken &&
          (urlTokenType === "github" || urlTokenType === "firebase")
        ) {
          // GitHub token from index.html
          githubToken = urlToken;
          tokenType = urlTokenType;
          console.log(`Received ${urlTokenType} token from URL`);

          if (urlTokenType === "firebase") {
            // If Firebase token was passed, auto-fill and validate
            firebaseToken = urlToken;
            document.getElementById("tokenSection").style.display = "none";
            document.getElementById("galleryContent").style.display = "block";
            setupGallery();
          }
          // If GitHub token, still need Firebase authentication
        }
      }

      // Initialize page
      window.onload = function () {
        getTokensFromUrl();
      };
    </script>
  </body>
</html>
