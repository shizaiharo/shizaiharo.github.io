<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gallery - Thumbnail Browser</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }

      .header {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
      }

      .header h1 {
        margin: 0;
        color: #333;
      }

      .controls {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .search-input,
      .decrypt-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .search-input {
        width: 250px;
      }

      .decrypt-input {
        width: 150px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: #007bff;
        color: white;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn:hover {
        opacity: 0.9;
      }

      .gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
      }

      .book-item {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }

      .book-item:hover {
        transform: translateY(-5px);
      }

      .thumbnail-wrapper {
        position: relative;
        aspect-ratio: 3/4;
        overflow: hidden;
      }

      .thumbnail-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #f8f9fa;
      }

      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #666;
        font-size: 12px;
      }

      .book-info {
        padding: 12px;
      }

      .book-number {
        font-weight: bold;
        color: #007bff;
        font-size: 12px;
      }

      .book-title {
        font-size: 14px;
        margin: 5px 0;
        font-weight: 500;
        line-height: 1.3;
      }

      .book-artist {
        font-size: 12px;
        color: #666;
      }

      .status {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error {
        color: #dc3545;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Gallery</h1>
      <div class="controls">
        <input
          type="text"
          id="searchInput"
          class="search-input"
          placeholder="Search by title, book number, or tags..."
          onkeyup="searchBooks()"
        />
        <input
          type="password"
          id="decryptKey"
          class="decrypt-input"
          placeholder="Decrypt key..."
        />
        <button class="btn btn-primary" onclick="decryptThumbnails()">
          Decrypt
        </button>
        <a href="#" id="backButton" class="btn btn-secondary">Back</a>
      </div>
    </div>

    <div id="status" class="status">Loading...</div>
    <div id="gallery" class="gallery"></div>

    <script>
      // Global variables
      let githubToken = "";
      let booksData = [];
      let filteredBooks = [];
      let db = null;

      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyBgHpfJmeGjIS51nXKzFey5jI5LlkWwULc",
        authDomain: "cloud-2f6b2.firebaseapp.com",
        databaseURL:
          "https://cloud-2f6b2-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "cloud-2f6b2",
        storageBucket: "cloud-2f6b2.firebasestorage.app",
        messagingSenderId: "686332242533",
        appId: "1:686332242533:web:c23058e3ebc7ecd241f48c",
        measurementId: "G-FGFG1K9Q1E",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();

      // Get GitHub token from URL
      function getTokenFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token");
        const type = urlParams.get("type");

        if (token && (type === "github" || token.startsWith("ghp_"))) {
          githubToken = token;
          console.log("GitHub token received:", token.substring(0, 10) + "...");
        } else if (token) {
          console.log(
            "Token received but not recognized as GitHub token:",
            type || "no type specified"
          );
          console.log("Token starts with:", token.substring(0, 4));
        } else {
          console.log("No token found in URL");
        }

        // Set back button URL
        const backUrl = token
          ? `index.html?token=${encodeURIComponent(token)}&type=${
              type || "github"
            }`
          : "index.html";
        document.getElementById("backButton").href = backUrl;
      }

      // Load books from Firebase
      async function loadBooks() {
        try {
          console.log("Loading books from Firebase...");
          const querySnapshot = await db.collection("Book").get();

          booksData = [];
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            // Only include books that have thumbnail_url
            if (data.thumbnail_url) {
              booksData.push({
                id: doc.id,
                ...data,
              });
            }
          });

          console.log(`Loaded ${booksData.length} books with thumbnails`);
          filteredBooks = [...booksData];
          displayBooks();
        } catch (error) {
          console.error("Error loading books:", error);
          document.getElementById("status").innerHTML =
            '<div class="error">Error loading books from Firebase</div>';
        }
      }

      // Display books in gallery
      function displayBooks() {
        const gallery = document.getElementById("gallery");
        const status = document.getElementById("status");

        if (filteredBooks.length === 0) {
          status.textContent = "No books found with thumbnails.";
          gallery.innerHTML = "";
          return;
        }

        status.style.display = "none";

        gallery.innerHTML = filteredBooks
          .map((book) => {
            const title = book.title || "Unknown Title";
            const artist = getArtist(book.tags);

            return `
                    <div class="book-item">
                        <div class="thumbnail-wrapper">
                            <img class="thumbnail-image" 
                                 src="data:image/svg+xml;base64,${btoa(
                                   '<svg xmlns="http://www.w3.org/2000/svg" width="200" height="250"><rect width="100%" height="100%" fill="#f8f9fa"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="14" fill="#666">Loading...</text></svg>'
                                 )}"
                                 data-thumbnail-url="${book.thumbnail_url}"
                                 data-book-id="${book.id}"
                                 alt="Book ${book.id}">
                            <div class="loading">Loading...</div>
                        </div>
                        <div class="book-info">
                            <div class="book-number">#${book.id}</div>
                            <div class="book-title">${escapeHtml(title)}</div>
                            <div class="book-artist">${escapeHtml(artist)}</div>
                        </div>
                    </div>
                `;
          })
          .join("");

        // Load thumbnails
        loadThumbnails();
      }

      // Extract artist from tags
      function getArtist(tags) {
        if (!tags || typeof tags !== "object") return "Unknown Artist";

        const artistFields = ["artist", "creator", "author"];
        for (const field of artistFields) {
          if (
            tags[field] &&
            Array.isArray(tags[field]) &&
            tags[field].length > 0
          ) {
            return tags[field].join(", ");
          }
        }
        return "Unknown Artist";
      }

      // Escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Load thumbnails
      async function loadThumbnails() {
        const images = document.querySelectorAll(".thumbnail-image");

        for (const img of images) {
          const thumbnailUrl = img.dataset.thumbnailUrl;
          const bookId = img.dataset.bookId;

          try {
            await loadThumbnail(img, thumbnailUrl);
          } catch (error) {
            console.error(
              `Failed to load thumbnail for book ${bookId}:`,
              error
            );
            img.src = `data:image/svg+xml;base64,${btoa(
              '<svg xmlns="http://www.w3.org/2000/svg" width="200" height="250"><rect width="100%" height="100%" fill="#f8f9fa" stroke="#dee2e6"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="14" fill="#dc3545">Load Error</text></svg>'
            )}`;
          }

          // Hide loading indicator
          const loading = img.parentElement.querySelector(".loading");
          if (loading) loading.style.display = "none";
        }
      }

      // Load single thumbnail from private GitHub repository
      async function loadThumbnail(img, thumbnailUrl, decrypt = false) {
        console.log("Loading thumbnail for book:", img.dataset.bookId);
        console.log("GitHub token available:", githubToken ? "Yes" : "No");
        console.log(
          "GitHub token length:",
          githubToken ? githubToken.length : 0
        );

        if (!githubToken) {
          throw new Error(
            "GitHub token required for private repository access"
          );
        }

        const bookId = img.dataset.bookId;

        // Use the thumbnail URL from Firebase instead of constructing GitHub API URL
        if (!thumbnailUrl) {
          throw new Error(`No thumbnail URL found for book ${bookId}`);
        }

        console.log("Using thumbnail URL from Firebase:", thumbnailUrl);

        // Convert raw GitHub URLs to API URLs to avoid CORS issues
        let apiUrl;
        const urlParts = thumbnailUrl
          .replace("https://raw.githubusercontent.com/", "")
          .split("/");

        console.log("URL parts:", urlParts);

        if (urlParts.length < 4) {
          throw new Error(`Invalid GitHub raw URL format: ${thumbnailUrl}`);
        }

        const user = urlParts[0];
        const repo = urlParts[1];
        const branch = urlParts[2];
        const filePath = urlParts.slice(3).join("/");

        console.log("Parsed URL components:");
        console.log("- User:", user);
        console.log("- Repo:", repo);
        console.log("- Branch:", branch);
        console.log("- File path:", filePath);

        // Include branch in API URL if it's not the default branch
        if (branch && branch !== "main" && branch !== "master") {
          apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/${filePath}?ref=${branch}`;
        } else {
          apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/${filePath}`;
        }
        console.log("Converted to API URL:", apiUrl);

        const response = await fetch(apiUrl, {
          headers: {
            Authorization: `token ${githubToken}`,
            Accept: "application/vnd.github.v3+json",
          },
        });

        console.log("Response status:", response.status);
        console.log(
          "Response headers:",
          Object.fromEntries(response.headers.entries())
        );

        if (!response.ok) {
          const errorText = await response.text();
          console.error("GitHub API error response:", errorText);
          if (response.status === 404) {
            throw new Error(`File not found: ${apiUrl}`);
          }
          if (response.status === 403) {
            throw new Error(
              `Access denied. Check GitHub token permissions for: ${apiUrl}`
            );
          }
          throw new Error(
            `GitHub API error: ${response.status} - ${errorText}`
          );
        }

        let bytes;

        // Always use GitHub API response format (since we converted raw URLs to API URLs)
        const data = await response.json();
        console.log("GitHub API response keys:", Object.keys(data));
        console.log("File size from API:", data.size || "N/A");
        console.log("File encoding:", data.encoding || "N/A");
        console.log("File type:", data.type || "N/A");
        console.log("File name:", data.name || "N/A");
        console.log("File path:", data.path || "N/A");
        console.log("Content length:", data.content ? data.content.length : 0);

        // Check if file is too large for GitHub API (>1MB)
        if (data.size && data.size > 1048576) {
          throw new Error(
            `File too large for GitHub API (${data.size} bytes > 1MB limit). Use Git LFS or direct download for book ${bookId}.`
          );
        }

        // Check if this is actually a directory
        if (data.type === "dir") {
          throw new Error(`Path points to a directory, not a file: ${apiUrl}`);
        }

        // Additional debugging for empty content
        if (!data.content) {
          console.error("Full GitHub API response for debugging:", data);
          throw new Error(
            `No content field in GitHub API response for book ${bookId}. File might not exist or be accessible at: ${apiUrl}`
          );
        }

        if (data.content.trim().length === 0) {
          console.error("GitHub API returned empty content (after trim)");
          console.error("Raw content value:", JSON.stringify(data.content));
          console.error("File size from API:", data.size);
          console.error("File encoding:", data.encoding);
          throw new Error(
            `Empty content in GitHub API response for book ${bookId}. File size: ${data.size}, Type: ${data.type}, Encoding: ${data.encoding}`
          );
        }

        const binaryString = atob(data.content.replace(/\s/g, ""));
        console.log("Decoded binary length:", binaryString.length);

        bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }

        if (decrypt) {
          const decryptKey = document.getElementById("decryptKey").value.trim();

          if (!decryptKey) {
            throw new Error("Decrypt key required");
          }

          console.log("Decrypting thumbnail for book:", bookId);
          const decryptedData = decryptXOR(bytes, decryptKey);

          // Try to detect if it's a valid image by checking magic bytes
          const magicBytes = Array.from(decryptedData.slice(0, 4));
          console.log("Decrypted magic bytes:", magicBytes);

          const blob = new Blob([decryptedData], { type: "image/png" });
          const objectUrl = URL.createObjectURL(blob);

          // Add error handling for image loading
          img.onload = () => {
            console.log(
              "Decrypted image loaded successfully for book:",
              bookId
            );
            URL.revokeObjectURL(objectUrl);
          };

          img.onerror = () => {
            console.error("Failed to load decrypted image for book:", bookId);
            URL.revokeObjectURL(objectUrl);
            // Show error placeholder
            img.src = `data:image/svg+xml;base64,${btoa(
              '<svg xmlns="http://www.w3.org/2000/svg" width="200" height="250"><rect width="100%" height="100%" fill="#f8f9fa" stroke="#dee2e6"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="14" fill="#dc3545">Decrypt Failed</text></svg>'
            )}`;
          };

          img.src = objectUrl;
        } else {
          // Create blob from encrypted/raw data
          const blob = new Blob([bytes], { type: "image/png" });
          img.src = URL.createObjectURL(blob);
        }
      }

      // XOR decryption (matching Python GHB.py encrypt_XOR function)
      function decryptXOR(data, key) {
        console.log("Decrypting with key:", key);
        console.log("Encrypted data length:", data.length);

        // Check for empty data
        if (data.length === 0) {
          throw new Error("Cannot decrypt: encrypted data is empty");
        }

        // Match Python logic exactly:
        // key = key[::-1]  (reverse the key)
        // key = key.encode('utf-8')  (encode to UTF-8)

        // Step 1: Reverse the key (same as Python key[::-1])
        const reversedKey = key.split("").reverse().join("");
        console.log("Reversed key:", reversedKey);

        // Step 2: Encode to UTF-8 bytes (same as Python key.encode('utf-8'))
        const keyBytes = new TextEncoder().encode(reversedKey);
        console.log("Key bytes after encoding:", Array.from(keyBytes));
        console.log("Key length:", keyBytes.length);

        // Step 3: XOR decryption (same as Python logic)
        const result = new Uint8Array(data.length);
        const keyLen = keyBytes.length;

        for (let i = 0; i < data.length; i++) {
          result[i] = data[i] ^ keyBytes[i % keyLen];
        }

        console.log(
          "Decrypted data first 20 bytes:",
          Array.from(result.slice(0, 20))
        );
        return result;
      }

      // Search books
      function searchBooks() {
        const query = document
          .getElementById("searchInput")
          .value.toLowerCase()
          .trim();

        if (!query) {
          filteredBooks = [...booksData];
        } else {
          filteredBooks = booksData.filter((book) => {
            const title = (book.title || "").toLowerCase();
            const bookId = book.id.toLowerCase();
            const artist = getArtist(book.tags).toLowerCase();

            // Search in tags
            let tagsText = "";
            if (book.tags && typeof book.tags === "object") {
              tagsText = JSON.stringify(book.tags).toLowerCase();
            }

            return (
              title.includes(query) ||
              bookId.includes(query) ||
              artist.includes(query) ||
              tagsText.includes(query)
            );
          });
        }

        displayBooks();
      }

      // Decrypt all thumbnails
      async function decryptThumbnails() {
        const decryptKey = document.getElementById("decryptKey").value.trim();

        if (!decryptKey) {
          alert("Please enter a decrypt key.");
          return;
        }

        const images = document.querySelectorAll(".thumbnail-image");

        for (const img of images) {
          const thumbnailUrl = img.dataset.thumbnailUrl;
          const bookId = img.dataset.bookId;

          try {
            await loadThumbnail(img, thumbnailUrl, true);
            console.log(`Decrypted thumbnail for book ${bookId}`);
          } catch (error) {
            console.error(
              `Failed to decrypt thumbnail for book ${bookId}:`,
              error
            );
          }
        }
      }

      // Initialize
      window.onload = function () {
        getTokenFromUrl();
        loadBooks();
      };
    </script>
  </body>
</html>
