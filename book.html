<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="pageTitle">Book Images</title>
    <style>
      #imagesContainer {
        display: flex;
        overflow-x: auto;
        height: 100vh;
      }
      #imagesContainer img {
        height: 100%;
        object-fit: contain;
      }
    </style>
  </head>
  <body>
    <h2 id="bookNameBeforeNumber">Book's name</h2>
    <div id="imagesContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script>
      async function displayImages(zip) {
        const imagesContainer = document.getElementById("imagesContainer");
        imagesContainer.innerHTML = ""; // Clear previous images

        for (const fileName of Object.keys(zip.files)) {
          const file = zip.files[fileName];

          if (!file.dir && /\.(jpe?g|png|gif)$/i.test(fileName)) {
            const blob = await file.async("blob");
            const img = document.createElement("img");
            img.src = URL.createObjectURL(blob);
            imagesContainer.appendChild(img);
          }
        }
      }

      async function loadBook() {
        const bookName = new URLSearchParams(window.location.search).get(
          "bookName"
        );

        if (!bookName) {
          alert("Missing book name.");
          return;
        }

        console.log("Loading book:", bookName);

        // Extract the number from the bookName and set it as the title
        const bookNumber = bookName.match(/\d+/)[0];
        const bookNumberWithBrackets = "[" + bookNumber + "]";
        const bookNameBeforeNumber = bookName.split(bookNumberWithBrackets)[0];
        document.getElementById("pageTitle").textContent = bookNumber;
        document.getElementById("bookNameBeforeNumber").textContent =
          bookNameBeforeNumber;

        try {
          const bookData = await getBookData(bookName);

          if (bookData) {
            const combinedData = base64ToArrayBuffer(bookData.data);
            const zip = await JSZip.loadAsync(combinedData);
            displayImages(zip);
          } else {
            alert("Book data not found.");
          }
        } catch (error) {
          console.error("Error retrieving book data:", error);
          alert("Failed to retrieve book data.");
        }
      }

      async function getBookData(bookName) {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open("bookDatabase", 1);

          request.onsuccess = function (event) {
            const db = event.target.result;
            const transaction = db.transaction("books", "readonly");
            const store = transaction.objectStore("books");

            const query = store.get(bookName);

            query.onsuccess = function () {
              const item = query.result;
              if (item) {
                console.log("Retrieved data type:", typeof item.data);
                console.log("First 50 chars:", item.data.slice(0, 50));
                console.log("Last 50 chars:", item.data.slice(-50));
                resolve(item);
              } else {
                console.log("No data found for book:", bookName);
                resolve(null);
              }
            };

            query.onerror = function () {
              console.error("Query error:", query.error);
              reject(query.error);
            };
          };

          request.onerror = function () {
            console.error("IndexedDB open error:", request.error);
            reject(request.error);
          };
        });
      }

      function base64ToArrayBuffer(base64) {
        try {
          let cleanedBase64 = base64.replace(/[^A-Za-z0-9+/=]/g, "");
          cleanedBase64 = cleanedBase64.replace(/-/g, "+").replace(/_/g, "/"); // Fix URL-safe encoding issues

          console.log("Cleaned base64 length:", cleanedBase64.length);
          console.log("Last 10 chars:", cleanedBase64.slice(-10));

          const binaryString = atob(cleanedBase64);
          console.log("atob OK");

          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          return bytes.buffer;
        } catch (error) {
          console.error("Base64 conversion failed:", error.message, base64);
          alert("Base64 decoding error. The book file might be corrupted.");
          return null;
        }
      }

      window.onload = loadBook;
    </script>
  </body>
</html>
